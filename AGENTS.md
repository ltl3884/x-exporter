# AGENTS.md
# 给自动化编码代理使用的仓库指南

## 仓库概览
- 本项目是 X (Twitter) 蓝 V 认证关注者抓取的浏览器端书签脚本
- 仅原生 JavaScript, 无依赖, 无构建工具
- 脚本运行环境是浏览器页面控制台, 不是 Node.js
- 主脚本: fetch_x_followers.js

## 运行与测试
- 无 build 命令, 无 lint 命令, 无 test 命令
- 运行方式: 打开 X 认证关注者页面, F12 控制台粘贴脚本执行
- 单测: 不存在, 无法运行单个测试
- 单次验证建议执行路径:
- 进入 BlueVerifiedFollowers 页面后再运行脚本
- 观察控制台是否打印“网络拦截器已启动”
- 至少滚动 1-2 次确认计数增长
- 等待脚本结束并检查 CSV 是否下载
- 手工验证建议:
- 确认脚本启动后控制台有启动日志
- 滚动后新增人数计数递增
- 结束时自动下载 CSV
- CSV 中字段顺序和内容正确

## 规则文件
- 未发现 .cursor/rules/ 或 .cursorrules
- 未发现 .github/copilot-instructions.md

## 代码风格
- 代码风格以 fetch_x_followers.js 为准
- 使用 IIFE 包裹, 避免污染全局命名空间
- 使用 const 优先, 需要重新赋值时使用 let
- 使用 4 空格缩进
- 使用分号结尾
- 使用单引号字符串, 除非需要模板字符串
- 变量命名使用 camelCase
- 常量命名使用全大写加下划线, 仅限配置对象
- 对象字段使用 snake_case 以匹配 API 字段

## 结构约定
- 文件内按功能块分区, 使用注释标题
- 主要流程:
- 配置与状态
- XHR Hook 拦截
- 响应解析与去重
- 自动滚动
- CSV 导出

## 文件布局
- 单文件脚本, 所有逻辑集中在 fetch_x_followers.js
- 顶部为配置与状态, 便于快速调整
- 中间为拦截与解析逻辑
- 末尾为滚动控制和导出

## 导入与模块
- 无 import 或 require
- 禁用外部依赖
- 仅使用浏览器内置 API

## 类型与数据处理
- 使用 Map 按 rest_id 去重
- 使用 optional chaining 安全访问深层字段
- 对可选字段提供默认值
- 对字符串输出做必要的转义
- 仅处理 userDisplayType 为 User 的条目
- 只提取必要字段, 避免写入冗余信息

## 数据字段约定
- 关键主键: rest_id
- 主要字段来源: result.core, result.legacy
- 关系字段: relationship_perspectives
- 兼容字段读取顺序: core 优先, legacy 兜底

## 命名与注释
- 函数名称使用动词开头, 体现行为
- 变量名要清晰表达业务含义
- 仅在复杂逻辑处增加注释
- 不要使用行尾注释

## 错误处理
- JSON 解析和不稳定字段访问需要 try/catch
- 对无法解析的响应静默忽略
- 控制台输出错误, 但不抛出导致脚本中断
- 解析错误不要中断滚动流程
- 捕获异常后保持原有计数与状态一致

## 日志与用户提示
- 使用 console.log 输出进度
- 关键状态用更明显的文案
- 结束时输出统计并触发下载
- 启动时清理控制台, 提升可读性
- 日志不要包含敏感信息或完整响应体

## CSV 导出规则
- 需要 BOM 以避免 Excel 中文乱码
- 需要转义双引号
- 字段顺序不要随意调整
- 文件名包含时间戳
- CSV 表头固定, 与 rows 顺序一一对应
- 布尔值保持 true/false 原样输出
- 数字字段不要包裹引号

## 自动滚动规则
- 使用随机间隔滚动以降低触发限制的风险
- 通过 maxScrolls 控制终止条件
- 保持对已有逻辑的最小改动
- 先滚动到底, 再进入随机间隔
- 结束后必须停止计时器

## 浏览器与环境约束
- 只能使用浏览器内置 API
- 不能使用 Node.js 特有模块或全局对象
- X 的 GraphQL 结构可能变化, 解析需稳健
- 脚本运行在用户页面环境, 注意性能

## 变更策略
- 变化尽量小, 不重构无关部分
- 不引入新模块或构建步骤
- 保持脚本零依赖
- 复用现有工具函数与流程
- 不修改导出字段顺序, 除非明确要求
- 避免新增全局变量

## 设计原则 (来自仓库约定)
- 代码简洁易懂, 不过度设计
- 控制圈复杂度, 能拆分就拆分
- 尽量复用已有逻辑
- 最小化修改范围

## 安全与合规
- 不收集或上传额外数据
- 不进行网络请求注入
- 不输出或记录敏感信息

## 代理执行建议
- 优先阅读 fetch_x_followers.js
- 任何改动先定位到对应功能块
- 如果新增配置项, 放在 CONFIG 中
- 如果新增日志, 保持现有语气
- 如需新增字段, 先确认来源层级是否稳定
- 变更后优先手工验证下载结果

## 示例工作流
- 修改抓取策略:
- 调整 CONFIG
- 更新滚动或终止逻辑
- 确保 CSV 导出仍可用

## 说明
- 本仓库没有标准化测试命令
- 所有验证都依赖浏览器手工检查
- 若需添加测试框架, 需明确用户要求
